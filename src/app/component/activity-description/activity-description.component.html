<div class="content-box">
  <div class="activity-header">
    <h1>
      {{ currentActivity.dimension }}:
      {{ currentActivity.name }}
    </h1>
    <button
      *ngIf="showCloseButton"
      class="close-button"
      mat-icon-button
      (click)="onCloseRequested()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="example-action-buttons">
    <button mat-raised-button (click)="openAll()">Expand All</button>
    <button mat-raised-button (click)="closeAll()">Collapse All</button>
  </div>

  <mat-accordion multi="true">
    <mat-expansion-panel [expanded]="false">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>UUID</b>
          <span class="uuid-preview">{{ (currentActivity.uuid || '').substring(0, 8) }}...</span>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <p id="uuid" [innerHTML]="currentActivity.uuid"></p>
    </mat-expansion-panel>

    <mat-expansion-panel *ngIf="currentActivity.description?.hasContent()">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>Description</b>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <p id="description" [innerHTML]="currentActivity.description?.render()"></p>
    </mat-expansion-panel>

    <mat-expansion-panel *ngIf="currentActivity.risk?.hasContent()">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>Risk</b>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <p id="risk" [innerHTML]="currentActivity.risk?.render()"></p>
    </mat-expansion-panel>

    <mat-expansion-panel *ngIf="currentActivity.measure?.hasContent()">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>Measure</b>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <p id="measure" [innerHTML]="currentActivity.measure?.render()"></p>
    </mat-expansion-panel>

    <mat-expansion-panel *ngIf="currentActivity.assessment?.hasContent()">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>Assessment</b>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <p id="assessment" [innerHTML]="currentActivity.assessment?.render()"></p>
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>Dependencies</b>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div *ngIf="currentActivity?.name">
        <app-dependency-graph
          [activityName]="currentActivity?.name || ''"
          (activityClicked)="onActivityClicked($event)">
        </app-dependency-graph>
      </div>
    </mat-expansion-panel>

    <mat-expansion-panel *ngIf="currentActivity.implementationGuide?.hasContent()">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>Implementation Guide</b>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <p id="implementationGuide" [innerHTML]="currentActivity.implementationGuide?.render()"></p>
    </mat-expansion-panel>

    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>Difficulty of Implementation</b>
          <div class="difficulty-summary">
            <span class="difficulty-indicator">
              <mat-icon class="difficulty-icon">school</mat-icon>
              <span class="difficulty-level level-{{currentActivity.difficultyOfImplementation?.knowledge}}">{{ this.KnowledgeLabel }}</span>
            </span>
            <span class="difficulty-indicator">
              <mat-icon class="difficulty-icon">schedule</mat-icon>
              <span class="difficulty-level level-{{currentActivity.difficultyOfImplementation?.time}}">{{ this.TimeLabel }}</span>
            </span>
            <span class="difficulty-indicator">
              <mat-icon class="difficulty-icon">people</mat-icon>
              <span class="difficulty-level level-{{currentActivity.difficultyOfImplementation?.resources}}">{{ this.ResourceLabel }}</span>
            </span>
          </div>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div class="difficulty-details">
        <div class="difficulty-detail-item">
          <mat-icon>school</mat-icon>
          <span class="detail-label">Knowledge:</span>
          <span class="difficulty-badge level-{{currentActivity.difficultyOfImplementation?.knowledge}}">{{ this.KnowledgeLabel }}</span>
        </div>
        <div class="difficulty-detail-item">
          <mat-icon>schedule</mat-icon>
          <span class="detail-label">Time:</span>
          <span class="difficulty-badge level-{{currentActivity.difficultyOfImplementation?.time}}">{{ this.TimeLabel }}</span>
        </div>
        <div class="difficulty-detail-item">
          <mat-icon>people</mat-icon>
          <span class="detail-label">Resources:</span>
          <span class="difficulty-badge level-{{currentActivity.difficultyOfImplementation?.resources}}">{{ this.ResourceLabel }}</span>
        </div>
      </div>
    </mat-expansion-panel>

    <mat-expansion-panel *ngIf="currentActivity.usefulness !== -1" [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>Usefulness</b>
          <div class="usefulness-stars">
            <mat-icon 
              *ngFor="let star of [1,2,3,4,5]" 
              class="star"
              [class.filled]="star <= (currentActivity.usefulness || 0)">
              {{star <= (currentActivity.usefulness || 0) ? 'star' : 'star_border'}}
            </mat-icon>
            <span class="usefulness-label">{{ this.UsefulnessLabel }}</span>
          </div>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div class="usefulness-details">
        <div class="usefulness-rating">
          <span class="rating-text">Rating: {{ currentActivity.usefulness }}/5</span>
          <div class="star-display">
            <mat-icon 
              *ngFor="let star of [1,2,3,4,5]" 
              class="star-large"
              [class.filled]="star <= (currentActivity.usefulness || 0)">
              {{star <= (currentActivity.usefulness || 0) ? 'star' : 'star_border'}}
            </mat-icon>
          </div>
          <span class="usefulness-description">{{ this.UsefulnessLabel }}</span>
        </div>
      </div>
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>Teams Evidence</b>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <mat-accordion multi="true">
        <mat-expansion-panel
          id="teamsEvidence"
          *ngFor="let item of this.currentActivity.teamsEvidence | keyvalue">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <b [innerHTML]="item.key"></b>
            </mat-panel-title>
          </mat-expansion-panel-header>
          <p [innerHTML]="item.value"></p>
        </mat-expansion-panel>
      </mat-accordion>
    </mat-expansion-panel>

    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>Implementation</b>
          <div class="implementation-preview">
            <span class="tool-count-badge">{{currentActivity.implementation?.length || 0}} tools</span>
          </div>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div class="implementation-tools">
        <div class="tool-card" *ngFor="let implement of this.currentActivity.implementation">
          <div class="tool-header" (click)="implement.expanded = !implement.expanded">
            <div class="tool-info">
              <h4 class="tool-name" [innerHTML]="implement['name']"></h4>
              <div class="tool-tags">
                <span class="tag-chip" *ngFor="let tag of implement['tags']" [innerHTML]="tag"></span>
              </div>
            </div>
            <mat-icon class="expand-icon" [class.rotated]="implement.expanded">expand_more</mat-icon>
          </div>
          
          <div class="tool-details" [class.expanded]="implement.expanded">
            <div class="tool-url" *ngIf="implement['url']">
              <mat-icon>link</mat-icon>
              <a [href]="implement['url']" target="_blank" [innerHTML]="implement['url']"></a>
            </div>
            <div class="tool-description" *ngIf="implement['description']">
              <p [innerHTML]="implement['description']"></p>
            </div>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>References</b>
          <div class="references-preview">
            <span class="reference-chip" *ngIf="currentActivity?.references?.samm2?.length">
              SAMM({{currentActivity?.references?.samm2?.length}})
            </span>
            <span class="reference-chip" *ngIf="currentActivity?.references?.iso27001_2017?.length">
              ISO-17({{currentActivity?.references?.iso27001_2017?.length}})
            </span>
            <span class="reference-chip" *ngIf="currentActivity?.references?.iso27001_2022?.length">
              ISO-22({{currentActivity?.references?.iso27001_2022?.length}})
            </span>
            <span class="reference-chip" *ngIf="currentActivity?.references?.openCRE?.length">
              <mat-icon class="reference-icon">link</mat-icon>CRE
            </span>
          </div>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div class="references-content">
        <div class="reference-section" *ngIf="currentActivity?.references?.samm2?.length">
          <h4>{{ SAMMVersion }}</h4>
          <div class="reference-tags">
            <span class="reference-tag" *ngFor="let samm of currentActivity?.references?.samm2">{{ samm }}</span>
          </div>
        </div>
        
        <div class="reference-section" *ngIf="currentActivity?.references?.iso27001_2017?.length">
          <h4>{{ ISOVersion }}</h4>
          <div class="reference-tags">
            <span class="reference-tag" *ngFor="let iso of currentActivity?.references?.iso27001_2017">{{ iso }}</span>
          </div>
        </div>
        
        <div class="reference-section" *ngIf="currentActivity?.references?.iso27001_2022?.length">
          <h4>{{ ISO22Version }}</h4>
          <div class="reference-tags">
            <span class="reference-tag" *ngFor="let iso22 of currentActivity?.references?.iso27001_2022">{{ iso22 }}</span>
          </div>
        </div>
        
        <div class="reference-section" *ngIf="currentActivity?.references?.openCRE?.length">
          <h4>{{ openCREVersion }}</h4>
          <div class="reference-links">
            <a 
              class="reference-link" 
              *ngFor="let openCRE of currentActivity?.references?.openCRE" 
              target="_blank" 
              [href]="openCRE">
              <mat-icon>open_in_new</mat-icon>
              View CRE
            </a>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>Implemented By</b>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div *ngIf="currentActivity.teamsImplemented; then thenBlock; else elseBlock"></div>
      <ng-template #thenBlock>
        <ul class="teams-implemented-list">
          <li *ngFor="let item of currentActivity.teamsImplemented | keyvalue">
            <b>{{ item.key }}</b
            >:{{ item.value }}
          </li>
        </ul>
      </ng-template>
      <ng-template #elseBlock
        >teamsImplemented variable not present <br />
        <p *ngIf="currentActivity.isImplemented === false">Not Implemented</p>
        <p *ngIf="currentActivity.isImplemented === true">Implemented</p>
      </ng-template>
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <b>Comments</b>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <p id="comments" [innerHTML]="currentActivity.comments?.render()"></p>
    </mat-expansion-panel>
  </mat-accordion>

  <mat-expansion-panel>
    <mat-expansion-panel-header>
      <mat-panel-title>
        <b>Tags</b>
      </mat-panel-title>
    </mat-expansion-panel-header>
    <p [innerHTML]="currentActivity.tags"></p>
  </mat-expansion-panel>
</div>
